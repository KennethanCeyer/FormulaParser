/************************************************************************************************************
 *
 * @ Version 1.1.1
 * @ Formula Parser
 * @ Date 11. 10. 2016
 * @ Author PIGNOSE
 * @ Licensed under MIT.
 *
 ***********************************************************************************************************/

function FormulaParser(r,t){this.formula=r,this.OperandToken={},this.OperandToken.Addition=["+"],this.OperandToken.Subtraction=["-"],this.OperandToken.Multiplication=["x","*"],this.OperandToken.Division=["/"],this.OperandToken.Mod=["%"],this.OperandToken.Pow=["^"],this.OperandToken.Bracket=["(",")","[","]","{","}"],this.OperandPriority=[],this.OperandPriority[0]=[].concat(this.OperandToken.Mod,this.OperandToken.Pow),this.OperandPriority[1]=[].concat(this.OperandToken.Multiplication,this.OperandToken.Division),this.OperandPriority[2]=[].concat(this.OperandToken.Addition,this.OperandToken.Subtraction),this.Operators=[];for(var e in this.OperandToken){var a=this.OperandToken[e];this.Operators=this.Operators.concat(a)}this.Units=[].concat(this.Operators,this.OperandToken.Bracket),this.Parsers=["LayerParser","SyntaxParser","FilterParser","StringParser"],this.ParserMap={};for(var e in this.Parsers){var s=this.Parsers[e];this.ParserMap[s]=s}return this.Message={},this.Message[1]="Formula must has characters than {0} times",this.Message[2]="'{0}' operator is not supported.",this.Message[3]="Left side operand is not valid.",this.Message[4]="Right side operand is not valid.",this.Message[5]="Bracket must be opened.",this.Message[6]="Bracket must be closed.",this.Message[32]="Operator's key must be in data.",this.Message[33]="Left operand's key must be in data.",this.Message[34]="Right operand's key must be in data.",this.init(t)}FormulaParser.prototype.inArray=function(r,t){for(var e in t)if(t[e]===r)return e;return-1},FormulaParser.prototype.isOperand=function(r){return"object"==typeof r||this.isNumeric(r)},FormulaParser.prototype.getOperatorPriority=function(r){if(-1===this.inArray(r,this.Operators))return-1;for(var t=-1,e=0;e<this.OperandPriority.length;e++)if(-1!==this.inArray(r,this.OperandPriority[e])){t=e;break}return t},FormulaParser.prototype.isNumeric=function(r){return/\d+(\.\d*)?|\.\d+/.test(r)},FormulaParser.prototype.stringToArray=function(r){for(var t=[],e=r.split(""),a=e.length,s=0;a>s;s++){var i=e[s];-1===this.inArray(i,this.Units)&&this.isOperand(i)===!1||(s>0&&this.isOperand(i)===!0&&this.isOperand(t[t.length-1])===!0?t[t.length-1]+=""+i:t.push(i))}return t},FormulaParser.prototype.log=function(r,t,e){var a=this.Message[r];for(var s in e){var i=e[s];a=a.replace(RegExp("\\{"+s+"\\}","g"),i)}var o={status:0===r,code:r,msg:a};if(void 0!==t)for(var s in t){var i=t[s];"function"!=typeof i&&(o[s]=i)}return o},FormulaParser.prototype.layerParser=function(r,t,e){var e=e||0,a=0,s=[],i=[],o=this.ParserMap.LayerParser,n=r.length;if(1===r.length&&"object"!=typeof r[0])return{status:!0,data:r[0],length:1};for(var h=0;h<r.length;h++){var p=r[h];if("("===p)a++,s[a]=h+1;else if(")"===p){if(1>a)return this.log(5,{stack:o,col:s.length>0?s[s.length-1]:0});if(1===a){var u=[];i[a]=h-1;for(var l=s[a];l<=i[a];l++)u.push(r[l]);var d=this.search(u,t+s[a]+1,e+1);if(d.status===!1)return d;var c=d.length;"object"==typeof d.data&&"object"!=typeof d.data[0]&&1===d.data.length&&(d.data=d.data[0]),r.splice(s[a]-1,c+2,d.data),h-=c+1}a--}}return a>0?this.log(6,{stack:o,col:r.length||-1}):{status:!0,depth:e,length:n||-1}},FormulaParser.prototype.syntaxParser=function(r,t,e,a,s){this.currentParser=this.ParserMap.SyntaxParser,r=r||[],t=t||0,e=e||0;var i=t;if("object"==typeof r[0][0]&&void 0===r[0].operator&&(r[0]=r[0][0]),r.length<3)return r.length>1||"object"!=typeof r[0]||void 0===r[0].operator?this.log(1,{stack:this.currentParser,col:t+("object"==typeof r[0]?r[0].length:0)+1},[3]):r[0];if(void 0!==r.length&&r.length>1)for(var o=0;o<r.length;o++){i=o+t;var n=r[o];if(-1===this.inArray(n,this.Operators)&&this.isOperand(n)===!1)return this.log(2,{stack:this.currentParser,col:i},[n]);if(-1!==this.inArray(n,s)){if(this.isOperand(r[o-1])===!1)return this.log(3,{stack:this.currentParser,col:i-1});if(this.isOperand(r[o+1])===!1)return this.log(4,{stack:this.currentParser,col:i+1});r.splice(o-1,3,{operator:n,operand1:r[o-1],operand2:r[o+1],length:a}),"object"==typeof r[o-1][0]&&(r[o-1]=r[o-1][0]),o--}}return{status:!0,data:r}},FormulaParser.prototype.filterParser=function(r){return"object"==typeof r[0]&&(r=r[0]),"object"==typeof r.operand1&&this.filterParser(r.operand1),"object"==typeof r.operand2&&this.filterParser(r.operand2),void 0!==r.length&&delete r.length,r},FormulaParser.prototype.stringParser=function(r,t,e){this.currentParser=this.ParserMap.StringParser;var a=this,s=[];if(t=t||0,e=e||0,void 0!==r.value)return{status:!0,data:"unit"===r.value.type?r.value.unit:r.value};if(void 0===r.operator)return this.log(32,{stack:this.currentParser,col:e,depth:t});if(void 0===r.operand1)return this.log(33,{stack:this.currentParser,col:e,depth:t});if(void 0===r.operand2)return this.log(34,{stack:this.currentParser,col:e,depth:t});for(var i=["operand1","operator","operand2"],o=0;o<i.length;o++){var n=i[o];if("object"==typeof r[n]){var h=a.stringParser(r[n],t+1,e+o);if(h.status===!1)return h;s=s.concat(h.data),void 0!==r.operator&&void 0!==h.operator&&this.getOperatorPriority(r.operator)<this.getOperatorPriority(h.operator)&&-1!==this.getOperatorPriority(r.operator)&&(s.splice([s.length-3],0,"("),s.splice([s.length],0,")"))}else s.push(r[n])}return{status:!0,data:s,operator:t>0?r.operator:void 0}},FormulaParser.prototype.search=function(r,t,e){var a=this;t=t||0,e=e||0,"string"==typeof r&&1>e&&(r=this.stringToArray(r));for(var s=null,i=this.OperandPriority.length+1,o=0,n=function(){return 0===e&&(r=a.filterParser(r)),{status:!0,data:r,length:0===e?void 0:o,depth:0===e?void 0:e}},h=0;i>h;h++){if(null!==s&&void 0!==s.data&&1===s.data.length)return n.call();if(0===h?(s=this.layerParser(r,t,e),o=s.length):s=this.syntaxParser(r,t,e,o,this.OperandPriority[h-1]),s.status===!1)return s;if(h+1===i)return n.call()}},FormulaParser.prototype.collapse=function(r,t){var e=null;return t=t||0,e=this.stringParser(r,t),{status:!0,data:e.data}},FormulaParser.prototype.init=function(r){return void 0===r||r===!1?this.search(this.formula):this.collapse(this.formula)};