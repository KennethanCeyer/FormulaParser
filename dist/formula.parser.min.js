//================================================================================
// [pg-formula-parser]
// version: 2.0.4
// update: 2016.11.11
//================================================================================

var FormulaParser=function(){function a(a){var b;this.formula=a,this.OperandToken={},this.OperandToken.Addition=["+"],this.OperandToken.Subtraction=["-"],this.OperandToken.Multiplication=["x","*"],this.OperandToken.Division=["/"],this.OperandToken.Mod=["%"],this.OperandToken.Pow=["^"],this.OperandToken.Bracket=["(",")","[","]","{","}"],this.OperandPriority=[],this.OperandPriority[0]=[].concat(this.OperandToken.Mod,this.OperandToken.Pow),this.OperandPriority[1]=[].concat(this.OperandToken.Multiplication,this.OperandToken.Division),this.OperandPriority[2]=[].concat(this.OperandToken.Addition,this.OperandToken.Subtraction),this.Operators=[];for(b in this.OperandToken){var c=this.OperandToken[b];this.Operators=this.Operators.concat(c)}this.Units=[].concat(this.Operators,this.OperandToken.Bracket),this.Parsers=["LayerParser","SyntaxParser","FilterParser","StringParser"],this.ParserMap={};for(b in this.Parsers){var d=this.Parsers[b];this.ParserMap[d]=d}return this.Message={},this.Message[1]="Formula must has characters than {0} times",this.Message[2]="'{0}' operator is not supported.",this.Message[3]="Left side operand is not valid.",this.Message[4]="Right side operand is not valid.",this.Message[5]="Bracket must be opened.",this.Message[6]="Bracket must be closed.",this.Message[32]="Operator's key must be in data.",this.Message[33]="Left operand's key must be in data.",this.Message[34]="Right operand's key must be in data.",this.init()}var b="2.0.4";return a.getVersion=function(){return b},a.prototype.inArray=function(a,b){for(var c in b)if(b[c]===a)return c;return-1},a.prototype.isOperand=function(a){return"object"==typeof a||this.isNumeric(a)},a.prototype.getOperatorPriority=function(a){if(this.inArray(a,this.Operators)===-1)return-1;for(var b=-1,c=0;c<this.OperandPriority.length;c++)if(this.inArray(a,this.OperandPriority[c])!==-1){b=c;break}return b},a.prototype.isNumeric=function(a){return/\d+(\.\d*)?|\.\d+/.test(a)},a.prototype.stringToArray=function(a){for(var b=[],c=a.split(""),d=c.length,e=0;e<d;e++){var f=c[e];this.inArray(f,this.Units)===-1&&this.isOperand(f)===!1||(e>0&&this.isOperand(f)===!0&&this.isOperand(b[b.length-1])===!0?b[b.length-1]+=f.toString():b.push(f))}return b},a.prototype.log=function(a,b,c){var d,e,f=this.Message[a];for(d in c)e=c[d],f=f.replace(new RegExp("\\{"+d+"\\}","g"),e);var g={status:0===a,code:a,msg:f};if("undefined"!=typeof b)for(d in b)e=b[d],"function"!=typeof e&&(g[d]=e);return g},a.prototype.layerParser=function(a,b,c){var d=0,e=[],f=[],g=this.ParserMap.LayerParser,h=a.length;if(c=c||0,1===a.length&&"object"!=typeof a[0])return{status:!0,data:a[0],length:1};for(var i=0;i<a.length;i++){var j=a[i];if("("===j)d++,e[d]=i+1;else if(")"===j){if(d<1)return this.log(5,{stack:g,col:e.length>0?e[e.length-1]:0});if(1===d){var k=[];f[d]=i-1;for(var l=e[d];l<=f[d];l++)k.push(a[l]);var m=this.search(k,b+e[d]+1,c+1);if(m.status===!1)return m;var n=m.length;"object"==typeof m.data&&"object"!=typeof m.data[0]&&1===m.data.length&&(m.data=m.data[0]),a.splice(e[d]-1,n+2,m.data),i-=n+1}d--}}return d>0?this.log(6,{stack:g,col:a.length||-1}):{status:!0,depth:c,length:h||-1}},a.prototype.syntaxParser=function(a,b,c,d,e){this.currentParser=this.ParserMap.SyntaxParser,a=a||[],b=b||0,c=c||0;var f=b;if("object"==typeof a[0][0]&&"undefined"==typeof a[0].operator&&(a[0]=a[0][0]),a.length<3)return a.length<=1&&"object"==typeof a[0]&&"undefined"!=typeof a[0].operator?a[0]:this.log(1,{stack:this.currentParser,col:b+("object"==typeof a[0]?a[0].length:0)+1},[3]);if("undefined"!=typeof a.length&&a.length>1)for(var g=0;g<a.length;g++){f=g+b;var h=a[g];if(this.inArray(h,this.Operators)===-1&&this.isOperand(h)===!1)return this.log(2,{stack:this.currentParser,col:f},[h]);if(this.inArray(h,e)!==-1){if(this.isOperand(a[g-1])===!1)return this.log(3,{stack:this.currentParser,col:f-1});if(this.isOperand(a[g+1])===!1)return this.log(4,{stack:this.currentParser,col:f+1});a.splice(g-1,3,{operator:h,operand1:a[g-1],operand2:a[g+1],length:d}),"object"==typeof a[g-1][0]&&(a[g-1]=a[g-1][0]),g--}}return{status:!0,data:a}},a.prototype.filterParser=function(a){return"object"==typeof a[0]&&(a=a[0]),"object"==typeof a.operand1&&this.filterParser(a.operand1),"object"==typeof a.operand2&&this.filterParser(a.operand2),"undefined"!=typeof a.length&&delete a.length,a},a.prototype.stringParser=function(a,b,c){this.currentParser=this.ParserMap.StringParser;var d=this,e=[];if(b=b||0,c=c||0,"undefined"!=typeof a.value)return{status:!0,data:"unit"===a.value.type?a.value.unit:a.value};if("undefined"==typeof a.operator)return this.log(32,{stack:this.currentParser,col:c,depth:b});if("undefined"==typeof a.operand1)return this.log(33,{stack:this.currentParser,col:c,depth:b});if("undefined"==typeof a.operand2)return this.log(34,{stack:this.currentParser,col:c,depth:b});for(var f=["operand1","operator","operand2"],g=0;g<f.length;g++){var h=f[g];if("object"==typeof a[h]){var i=d.stringParser(a[h],b+1,c+g);if(i.status===!1)return i;e=e.concat(i.data),"undefined"!=typeof a.operator&&"undefined"!=typeof i.operator&&this.getOperatorPriority(a.operator)<this.getOperatorPriority(i.operator)&&this.getOperatorPriority(a.operator)!==-1&&(e.splice([e.length-3],0,"("),e.splice([e.length],0,")"))}else e.push(a[h])}return{status:!0,data:e,operator:b>0?a.operator:void 0}},a.prototype.search=function(a,b,c){var d=this;b=b||0,c=c||0,"string"==typeof a&&c<1&&(a=this.stringToArray(a));for(var e=null,f=this.OperandPriority.length+1,g=0,h=function(){return 0===c&&(a=d.filterParser(a)),{status:!0,data:a,length:0===c?void 0:g,depth:0===c?void 0:c}},i=0;i<f;i++){if(null!==e&&"undefined"!=typeof e.data&&1===e.data.length)return h.call();if(0===i?(e=this.layerParser(a,b,c),g=e.length):e=this.syntaxParser(a,b,c,g,this.OperandPriority[i-1]),e.status===!1)return e;if(i+1===f)return h.call()}},a.prototype.collapse=function(a,b){var c=null;return b=b||0,c=this.stringParser(a,b),{status:!0,data:c.data}},a.prototype.init=function(){return"string"==typeof this.formula||"object"==typeof this.formula&&"undefined"==typeof this.formula.operator?this.search(this.formula):"object"==typeof this.formula&&"undefined"!=typeof this.formula.operator?this.collapse(this.formula):void console.error("Unkown type formula",this.formula)},a}();