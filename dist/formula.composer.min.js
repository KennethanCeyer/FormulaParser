/************************************************************************************************************
 *
 * @ Version 1.0.1
 * @ Formula Parser
 * @ Date 03. 17. 2016
 * @ Author PIGNOSE
 * @ Licensed under MIT.
 *
 ***********************************************************************************************************/
function formulaComposer(a){return this.formula=a,this.primaryPriority=["*","x","/","%"],this.secondaryPriority=["+","-","&"],this.permittedOperators=["+","-","*","x","/"],this.permittedLetters=["(",")"].concat(this.permittedOperators),this.init()}formulaComposer.prototype.inArray=function(a,b){for(var c in b)if(b[c]==a)return c;return-1},formulaComposer.prototype.isOperand=function(a){return"object"==typeof a||this.isNumeric(a)},formulaComposer.prototype.isNumeric=function(a){return/\d+(\.\d*)?|\.\d+/.test(a)},formulaComposer.prototype.stringToArray=function(a){var b=[],c=a.split("");for(var d in c){var e=c[d];(-1!=this.inArray(e,this.permittedLetters)||this.isOperand(e))&&(d>0&&this.isOperand(e)&&this.isOperand(b[b.length-1])?b[b.length-1]+=e.toString():b.push(e))}return b},formulaComposer.prototype.layerParser=function(a,b){for(var c=null,d=0;d<a.length;d++){var e=a[d];if("("==e)for(var f=1,g=d+1;g<a.length;g++){var h=a[g];if("("==h)f++;else if(")"==h&&(f--,0==f)){for(var i=[],j=d+1;g>j;j++)i.push(a[j]);var k=this.search(i,b+1);if(0==k.result)return k;a.splice(d,g-d+1,k.data),c=k.depth,d--;break}if(a.length==g+1)return{result:!1,col:g,stack:"layerParser",msg:"The bracket isn't closed"}}else if(")"==e)return{result:!1,col:d,stack:"layerParser",msg:"The bracket isn't opened"}}return{result:!0,depth:c||b}},formulaComposer.prototype.syntaxParser=function(a,b,c,d){if(a.length<3&&(d>1||1==d&&a.length>1))return{result:!1,col:0,stack:"syntaxParser",msg:"Formula must has characters than 3 times"};if(!(a.length>2))return{result:!0,data:{operator:"=",operand1:a[0]}};for(var e=1;e<a.length-1;e++){var f=a[e];if(-1==this.inArray(f,this.permittedOperators)&&!this.isOperand(f))return{result:!1,col:e,stack:"syntaxParser",msg:"'"+f+"' mark is not supported."};if(-1!=this.inArray(f,c)){if(!this.isOperand(a[e-1]))return{result:!1,col:e-1,stack:"syntaxParser"};if(!this.isOperand(a[e+1]))return{result:!1,col:e+1,stack:"syntaxParser"};var g={operator:f,operand1:a[e-1],operand2:a[e+1]};a.splice(e-1,3,g),1==a.length&&"object"==typeof a[0]&&(a=a[0]),e--}}return{result:!0,data:a}},formulaComposer.prototype.search=function(a,b){"undefined"==typeof b&&(b=1),"string"==typeof a&&(a=this.stringToArray(a));var c=this.layerParser(a,b),d=c.depth;if(0==c.result)return c;var c=this.syntaxParser(a,b,this.primaryPriority,d);if(0==c.result||1==d)return c;a=c.data;var c=this.syntaxParser(a,b,this.secondaryPriority,d);return 0==c.result?c:(a=c.data,{result:!0,data:a,depth:d})},formulaComposer.prototype.init=function(){return this.search(this.formula)};