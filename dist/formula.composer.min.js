/************************************************************************************************************
 *
 * @ Version 1.0.4
 * @ Formula Parser
 * @ Date 03. 25. 2016
 * @ Author PIGNOSE
 * @ Licensed under MIT.
 *
 ***********************************************************************************************************/

function formulaComposer(a,b){return this.formula=a,this.primaryPriority=["*","x","/","%"],this.secondaryPriority=["+","-","&"],this.permittedOperators=["+","-","*","x","/"],this.permittedLetters=["(",")"].concat(this.permittedOperators),this.init(b)}formulaComposer.prototype.getIndex=function(a,b){return b[a]?b[a]:b[b.length-1]},formulaComposer.prototype.inArray=function(a,b){for(var c in b)if(b[c]==a)return c;return-1},formulaComposer.prototype.isOperand=function(a){return"object"==typeof a||this.isNumeric(a)},formulaComposer.prototype.isNumeric=function(a){return/\d+(\.\d*)?|\.\d+/.test(a)},formulaComposer.prototype.stringToArray=function(a){var b=[],c=a.split("");for(var d in c){var e=c[d];(-1!=this.inArray(e,this.permittedLetters)||this.isOperand(e))&&(d>0&&this.isOperand(e)&&this.isOperand(b[b.length-1])?b[b.length-1]+=e.toString():b.push(e))}return b},formulaComposer.prototype.layerParser=function(a,b,c,d){for(var e=null,f=b,g=0;g<a.length;g++){var h=a[g];if("("==h)for(var i=1,j=g+1;j<a.length;j++){var k=a[j];if("("==k)i++;else if(")"==k&&(i--,0===i)){for(var l=[],m=g+1;j>m;m++)l.push(a[m]);var n=this.search(l,b+g+1,c+1);if(n.result===!1)return n;a.splice(g,j-g+1,n.data),f=j+b,e=n.depth}if(a.length==j+1)return{result:!1,col:b+j,stack:"layerParser",msg:"The bracket isn't closed",map:d}}else if(")"==h)return{result:!1,col:b,stack:"layerParser",msg:"The bracket isn't opened",map:d};d.push(f),f++}return{result:!0,depth:e||c,map:d}},formulaComposer.prototype.syntaxParser=function(a,b,c,d,e,f){if(a.length<3&&1>=f||1==f&&a.length<1)return{result:!1,col:b,stack:"syntaxParser",msg:"Formula must has characters than 3 times"};if("undefined"!=typeof a.length)if(a.length>1)for(var g=0;g<a.length;g++){var h=a[g];if(-1==this.inArray(h,this.permittedOperators)&&!this.isOperand(h))return{result:!1,col:this.getIndex(b+g,d),stack:"syntaxParser",msg:"'"+h+"' mark is not supported.",map:d};if(-1!=this.inArray(h,e)){if(!this.isOperand(a[g-1]))return{result:!1,col:this.getIndex(b+g-1,d),stack:"syntaxParser",msg:"Left side operand is not valid.",map:d};if(!this.isOperand(a[g+1]))return{result:!1,col:this.getIndex(b+g+1,d),stack:"syntaxParser",msg:"Right side operand is not valid.",map:d};var i={operator:h,operand1:a[g-1],operand2:a[g+1]};a.splice(g-1,3,i),g--}else if(this.isOperand(a[g])){if(g-1>0&&-1==this.inArray(a[g-1],this.permittedOperators))return{result:!1,col:this.getIndex(b+g-1,d),stack:"syntaxParser",msg:"Left side operator is not valid.",map:d};if(g+1<a.length&&-1==this.inArray(a[g+1],this.permittedOperators))return{result:!1,col:this.getIndex(b+g+1,d),stack:"syntaxParser",msg:"Right side operator is not valid.",map:d}}}else if(1==f)return{result:!0,data:{operator:"=",operand1:a[0]}};return 1==a.length&&"object"==typeof a[0]&&(a=a[0]),{result:!0,data:a}},formulaComposer.prototype.formulaParser=function(a,b){var c=this,d=[];if("undefined"==typeof a.operator)return{result:!1,depth:b,col:"operator unit",stack:"collapse",msg:"operator key must be in data"};if("undefined"==typeof a.operand1)return{result:!1,depth:b,col:"operand1 unit",stack:"collapse",msg:"operand1 key must be in data"};if("undefined"==typeof a.operand2)return{result:!1,depth:b,col:"operand2 unit",stack:"collapse",msg:"operand2 key must be in data"};var e=["operand1","operator","operand2"];for(var f in e){var g=e[f];if("object"==typeof a[g]){var h=c.formulaParser(a[g],b+1);if(0==h.result)return h;d=d.concat(["("].concat(h.data).concat([")"]))}else d.push(a[g])}return{result:!0,data:d}},formulaComposer.prototype.search=function(a,b,c,d){"undefined"==typeof b&&(b=0),"undefined"==typeof c&&(c=1),"undefined"==typeof d&&(d=[]),"string"==typeof a&&(a=this.stringToArray(a));var e=null;e=this.layerParser(a,b,c,d);var f=e.depth;return e.result===!1?e:(e=this.syntaxParser(a,b,c,e.map,this.primaryPriority,f),e.result===!1?e:(a=e.data,e=this.syntaxParser(a,b,c,e.map,this.secondaryPriority,f),e.result===!1?e:(a=e.data,{result:!0,data:a,depth:f,map:e.map})))},formulaComposer.prototype.collapse=function(a,b){"undefined"==typeof b&&(b=1);var d=this.formulaParser(a,b);return{result:!0,data:d.data.join(" ")}},formulaComposer.prototype.init=function(a){return"undefined"==typeof a||0==a?this.search(this.formula):this.collapse(this.formula)};