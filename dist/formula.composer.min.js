/************************************************************************************************************
 *
 * @ Version 1.0.3
 * @ Formula Parser
 * @ Date 03. 17. 2016
 * @ Author PIGNOSE
 * @ Licensed under MIT.
 *
 ***********************************************************************************************************/

function formulaComposer(r){return this.formula=r,this.primaryPriority=["*","x","/","%"],this.secondaryPriority=["+","-","&"],this.permittedOperators=["+","-","*","x","/"],this.permittedLetters=["(",")"].concat(this.permittedOperators),this.init()}formulaComposer.prototype.inArray=function(r,t){for(var e in t)if(t[e]==r)return e;return-1},formulaComposer.prototype.isOperand=function(r){return"object"==typeof r||this.isNumeric(r)},formulaComposer.prototype.isNumeric=function(r){return/\d+(\.\d*)?|\.\d+/.test(r)},formulaComposer.prototype.stringToArray=function(r){var t=[],e=r.split("");for(var s in e){var i=e[s];(-1!=this.inArray(i,this.permittedLetters)||this.isOperand(i))&&(s>0&&this.isOperand(i)&&this.isOperand(t[t.length-1])?t[t.length-1]+=""+i:t.push(i))}return t},formulaComposer.prototype.layerParser=function(r,t){for(var e=null,s=0;s<r.length;s++){var i=r[s];if("("==i)for(var a=1,o=s+1;o<r.length;o++){var n=r[o];if("("==n)a++;else if(")"==n&&(a--,0===a)){for(var p=[],l=s+1;o>l;l++)p.push(r[l]);var u=this.search(p,t+1);if(u.result===!1)return u;r.splice(s,o-s+1,u.data),e=u.depth,s--;break}if(r.length==o+1)return{result:!1,col:o,stack:"layerParser",msg:"The bracket isn't closed"}}else if(")"==i)return{result:!1,col:s,stack:"layerParser",msg:"The bracket isn't opened"}}return{result:!0,depth:e||t}},formulaComposer.prototype.syntaxParser=function(r,t,e,s){if(r.length<3&&1>=s||1==s&&r.length<1)return{result:!1,col:0,stack:"syntaxParser",msg:"Formula must has characters than 3 times"};if(void 0!==r.length)if(r.length>1)for(var i=0;i<r.length;i++){var a=r[i];if(-1==this.inArray(a,this.permittedOperators)&&!this.isOperand(a))return{result:!1,col:i,stack:"syntaxParser",msg:"'"+a+"' mark is not supported."};if(-1!=this.inArray(a,e)){if(!this.isOperand(r[i-1]))return{result:!1,col:i-1,stack:"syntaxParser",msg:"Left side operand is not valid."};if(!this.isOperand(r[i+1]))return{result:!1,col:i+1,stack:"syntaxParser",msg:"Right side operand is not valid."};var o={operator:a,operand1:r[i-1],operand2:r[i+1]};r.splice(i-1,3,o),i--}else if(this.isOperand(r[i])){if(i-1>0&&-1==this.inArray(r[i-1],this.permittedOperators))return{result:!1,col:i-1,stack:"syntaxParser",msg:"Left side operator is not valid."};if(i+1<r.length&&-1==this.inArray(r[i+1],this.permittedOperators))return{result:!1,col:i+1,stack:"syntaxParser",msg:"Right side operator is not valid."}}}else if(1==s)return{result:!0,data:{operator:"=",operand1:r[0]}};return 1==r.length&&"object"==typeof r[0]&&(r=r[0]),{result:!0,data:r}},formulaComposer.prototype.search=function(r,t){void 0===t&&(t=1),"string"==typeof r&&(r=this.stringToArray(r));var e=null;e=this.layerParser(r,t);var s=e.depth;return e.result===!1?e:(e=this.syntaxParser(r,t,this.primaryPriority,s),e.result===!1?e:(r=e.data,e=this.syntaxParser(r,t,this.secondaryPriority,s),e.result===!1?e:(r=e.data,{result:!0,data:r,depth:s})))},formulaComposer.prototype.init=function(){return this.search(this.formula)};